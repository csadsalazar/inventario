USE Gestion_Inventario;
GO

select * from MA_Bienes; 
select * from MA_Usuarios; 
select * from PA_BienesPorUsuario; 


-- Tabla de Usuarios
CREATE TABLE MA_Usuarios (
    PK_idUsuario INT IDENTITY(1,1) PRIMARY KEY,
    nombre NVARCHAR(50),
    usuario NVARCHAR(15),
    cedula INT,
    contrasena NVARCHAR(20),
    dependencia INT NOT NULL,
    cargo NVARCHAR(20) NOT NULL,
    contrato NVARCHAR(20) NOT NULL,
    sede NVARCHAR(30) NOT NULL
);
GO

-- Tabla de Bienes
CREATE TABLE MA_Bienes (
    idBien INT IDENTITY(1,1) PRIMARY KEY,
    PK_Codigo INT,
    nombre NVARCHAR(50),
    placa NVARCHAR(6),
    descripcion NVARCHAR(150),
    valor INT,
    FK_Usuario INT,
    ubicacion NVARCHAR(50),
    estado NVARCHAR(12),
    imagen1 NVARCHAR(50),
    imagen2 NVARCHAR(50),
    FOREIGN KEY (FK_Usuario) REFERENCES MA_Usuarios(PK_idUsuario)
);
GO

-- Tabla de Bienes por Usuario
CREATE TABLE PA_BienesPorUsuario (
    PK_idBienPorUsuario INT IDENTITY(1,1) PRIMARY KEY,   
    FK_Usuario INT,
    FK_Bien INT,
    asunto NVARCHAR(25),
    informacion NVARCHAR(200),
    fechaObservacion DATE NOT NULL,
    FOREIGN KEY (FK_Usuario) REFERENCES MA_Usuarios(PK_idUsuario),
    FOREIGN KEY (FK_Bien) REFERENCES MA_Bienes(idBien)
);
GO

-- PROCEDURES FOR BIENES

CREATE PROCEDURE AgregarBien (
    @codigo INT,
    @nombre NVARCHAR(50),
    @placa NVARCHAR(6),
    @descripcion NVARCHAR(150),
    @valor INT,
    @FK_Usuario INT,
    @ubicacion NVARCHAR(50),
    @estado NVARCHAR(12),
    @imagen1 NVARCHAR(50),
    @imagen2 NVARCHAR(50)
)
AS
BEGIN
    INSERT INTO MA_Bienes (PK_Codigo, nombre, placa, descripcion, valor, FK_Usuario, ubicacion, estado, imagen1, imagen2)
    VALUES (@codigo, @nombre, @placa, @descripcion, @valor, @FK_Usuario, @ubicacion, @estado, @imagen1, @imagen2);
END;
GO

CREATE PROCEDURE ActualizarBien (
    @placa NVARCHAR(6),
    @nombre NVARCHAR(50),
    @ubicacion NVARCHAR(50),
    @descripcion NVARCHAR(150),
    @valor INT,
    @codigoBien INT
)
AS
BEGIN
    UPDATE MA_Bienes
    SET placa = @placa,
        nombre = @nombre,
        ubicacion = @ubicacion,
        descripcion = @descripcion,
        valor = @valor
    WHERE PK_Codigo = @codigoBien;
END;
GO

CREATE PROCEDURE ObtenerDetalleBien(@codigo INT)
AS
BEGIN
    SELECT b.PK_Codigo, b.placa, b.nombre, b.descripcion, b.ubicacion, bu.informacion,
           u.nombre AS nombreUsuario, u.dependencia, u.cargo, u.sede 
    FROM MA_Bienes b 
    INNER JOIN MA_Usuarios u ON b.FK_Usuario = u.PK_idUsuario 
    INNER JOIN PA_BienesPorUsuario bu ON b.idBien = bu.FK_Bien 
    WHERE b.PK_Codigo = @codigo;
END;
GO


CREATE PROCEDURE ListarBienes
AS
BEGIN
    SELECT b.idBien,
           b.PK_Codigo,
           b.placa,
           b.nombre,
           u.usuario,
           u.dependencia,
           b.valor 
    FROM MA_Bienes b 
    INNER JOIN MA_Usuarios u ON b.FK_Usuario = u.PK_idUsuario;
END;
GO

CREATE PROCEDURE ListarObservaciones
AS
BEGIN
    SELECT bu.FK_Usuario,
           u.PK_idUsuario,
           u.usuario,
           u.dependencia,
           bu.asunto,
           bu.informacion 
    FROM PA_BienesPorUsuario bu 
    INNER JOIN MA_Usuarios u ON bu.FK_Usuario = u.PK_idUsuario;
END;
GO

-- PROCEDURE FOR OBSERVACIONES

CREATE PROCEDURE AgregarObservacion (
    @usuario INT,
    @bien INT,
    @asunto NVARCHAR(50),
    @informacion NVARCHAR(250), 
    @fechaObservacion DATE
)
AS
BEGIN
    INSERT INTO PA_BienesPorUsuario (FK_Usuario, FK_Bien, asunto, informacion, fechaObservacion)
    VALUES (@usuario, @bien, @asunto, @informacion, @fechaObservacion);
END;
GO



-- INSERCIONES 
INSERT INTO MA_Usuarios (nombre, usuario, cedula, contrasena, dependencia, cargo, contrato, sede)
VALUES ('NombreUsuario1', 'usuario1', 123456789, 'contrasena1', 1, 'Cargo1', 'Contrato1', 'INVIMA'),
       ('NombreUsuario2', 'usuario2', 987654321, 'contrasena2', 2, 'Cargo2', 'Contrato2', 'INVIMA'),
       ('NombreUsuario3', 'usuario3', 456789123, 'contrasena3', 3, 'Cargo3', 'Contrato3', 'INVIMA');

INSERT INTO MA_Bienes (PK_Codigo, nombre, placa, descripcion, valor, FK_Usuario, ubicacion, estado, imagen1, imagen2)
VALUES (1, 'NombreBien1', '1000', 'Descripción1', 1000, 1, 'Ubicación1', 'No reportado', 'Imagen1', 'Imagen1.1'),
       (2, 'NombreBien2', '2000', 'Descripción2', 2000, 2, 'Ubicación2', 'Reportado', 'Imagen2', 'Imagen2.1'),
       (3, 'NombreBien3', '3000', 'Descripción3', 3000, 3, 'Ubicación3', 'Reportado', 'Imagen3', 'Imagen3.1');

INSERT INTO PA_BienesPorUsuario (FK_Usuario, FK_Bien, asunto, informacion, fechaObservacion)
VALUES (1, 1, 'Asunto1', 'Información1', '2024-04-07'),
       (2, 2, 'Asunto2', 'Información2', '2024-04-08'),
       (3, 3, 'Asunto3', 'Información3', '2024-04-09');
